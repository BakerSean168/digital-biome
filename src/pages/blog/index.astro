---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { sortPostsByDate, getAllTags } from '../../utils/helpers';
import { formatDate } from '../../utils/date';

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« ï¼ˆæ’é™¤è‰ç¨¿ï¼‰
const allPosts = await getCollection('blog', ({ data }: { data: Record<string, any> }) => !data.draft);
const sortedPosts = sortPostsByDate(allPosts as CollectionEntry<'blog'>[]);
const allTags = getAllTags(sortedPosts);

interface Props {
  posts: typeof sortedPosts;
  tags: string[];
}
---

<Layout title="Blog | Digital Biome" description="æˆ‘çš„çŸ¥è¯†åšå®¢å’ŒæŠ€æœ¯åˆ†äº«">
  <div class="blog-container">
    <div class="blog-header">
      <h1>ğŸ“š Blog</h1>
      <p>åˆ†äº«çŸ¥è¯†ã€æŠ€æœ¯å’Œæƒ³æ³•çš„åœ°æ–¹</p>
    </div>

    <div class="blog-content">
      <!-- æ ‡ç­¾ä¾§æ  -->
      <aside class="blog-tags">
        <h3>Tags</h3>
        <div class="tag-list">
          <a href="/blog" class="tag-item">
            All ({sortedPosts.length})
          </a>
          {allTags.map((tag) => (
            <span class="tag-item">{tag}</span>
          ))}
        </div>
      </aside>

      <!-- æ–‡ç« åˆ—è¡¨ -->
      <main class="blog-posts">
        {sortedPosts.length === 0 ? (
          <p class="no-posts">æš‚æ— æ–‡ç« ï¼Œæ•¬è¯·æœŸå¾…...</p>
        ) : (
          <div class="posts-grid">
            {sortedPosts.map((post) => (
              <article class="post-card">
                <h2 class="post-title">
                  <a href={`/blog/${post.slug}`}>{post.data.title}</a>
                </h2>
                
                <div class="post-meta">
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDate(post.data.pubDate)}
                  </time>
                  <span class="post-reading-time">5 min read</span>
                </div>

                <p class="post-description">{post.data.description}</p>

                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="post-tags">
                    {post.data.tags.map((tag: string) => (
                      <span class="post-tag">{tag}</span>
                    ))}
                  </div>
                )}

                <a href={`/blog/${post.slug}`} class="read-more">
                  ç»§ç»­é˜…è¯» â†’
                </a>
              </article>
            ))}
          </div>
        )}
      </main>
    </div>
  </div>
</Layout>

<style>
  .blog-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-2xl) var(--spacing-lg);
  }

  .blog-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
  }

  .blog-header h1 {
    font-size: 3rem;
    margin-bottom: var(--spacing-md);
  }

  .blog-header p {
    font-size: 1.2rem;
    color: var(--color-text-secondary);
  }

  .blog-content {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: var(--spacing-2xl);
  }

  .blog-tags {
    background: var(--color-border);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius-md);
    height: fit-content;
    position: sticky;
    top: 100px;
  }

  .blog-tags h3 {
    margin: 0 0 var(--spacing-md) 0;
  }

  .tag-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .tag-item {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-bg);
    border-radius: var(--border-radius-sm);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tag-item:hover {
    background: var(--color-primary);
    color: white;
  }

  .posts-grid {
    display: grid;
    gap: var(--spacing-lg);
  }

  .post-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-md);
    padding: var(--spacing-lg);
    transition: all 0.3s;
  }

  .post-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
  }

  .post-title {
    margin: 0 0 var(--spacing-md) 0;
  }

  .post-title a {
    color: var(--color-text);
  }

  .post-title a:hover {
    color: var(--color-primary);
  }

  .post-meta {
    display: flex;
    gap: var(--spacing-md);
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
  }

  .post-description {
    margin-bottom: var(--spacing-md);
    line-height: 1.6;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .post-tag {
    background: rgba(0, 102, 204, 0.1);
    color: var(--color-primary);
    padding: 2px 8px;
    border-radius: var(--border-radius-sm);
    font-size: 0.85rem;
  }

  .read-more {
    font-weight: 600;
    color: var(--color-primary);
  }

  .no-posts {
    text-align: center;
    color: var(--color-text-secondary);
    padding: var(--spacing-2xl);
  }

  @media (max-width: 768px) {
    .blog-content {
      grid-template-columns: 1fr;
    }

    .blog-tags {
      position: relative;
      top: 0;
    }

    .tag-list {
      flex-direction: row;
      flex-wrap: wrap;
    }

    .blog-header h1 {
      font-size: 2rem;
    }
  }
</style>
