---
import { getCollection, render } from 'astro:content';
import NotesLayout from '../../layouts/NotesLayout.astro';
import Backlinks from '../../components/notes/Backlinks.astro';

export async function getStaticPaths() {
  const entries = await getCollection('notes', ({ data }) => !data.draft && !(data as any).private);

  return entries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

interface Props {
  entry: any;
}

const { entry } = Astro.props;
const slug = entry.id;

const { Content, headings } = await render(entry);
const { title, description, tags, created, updated } = entry.data;
---

<NotesLayout
  title={title}
  description={description || ''}
  headings={headings}
  currentSlug={slug}
>
  <header class="mb-8 pb-4 border-b border-border">
    <h1 class="text-3xl font-bold mb-2 text-foreground">{title}</h1>
    {description && <p class="text-muted-foreground m-0">{description}</p>}
  </header>

  {tags?.length > 0 && (
    <div class="flex gap-2 flex-wrap mb-6">
      {tags.map((tag: string) => {
        const display = tag.includes('/') ? tag.split('/').join(' / ') : tag;
        return (
          <span class="text-xs px-2.5 py-1 bg-primary/10 text-primary rounded-md border border-primary/20" title={tag}>
            #{display}
          </span>
        );
      })}
    </div>
  )}

  <div class="prose prose-neutral dark:prose-invert max-w-none 
              prose-a:text-primary prose-a:no-underline hover:prose-a:underline
              prose-headings:font-bold prose-headings:text-foreground
              prose-h2:border-b prose-h2:border-border prose-h2:pb-2 prose-h2:mt-10
              prose-p:text-foreground/90
              prose-code:text-primary prose-code:bg-primary/10 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
              prose-pre:bg-card prose-pre:border prose-pre:border-border
              prose-blockquote:border-l-primary prose-blockquote:bg-primary/5 prose-blockquote:py-1 prose-blockquote:px-4 prose-blockquote:not-italic prose-blockquote:text-muted-foreground
              prose-img:rounded-lg prose-img:border prose-img:border-border
              prose-hr:border-border">
    <Content />
  </div>

  {(created || updated) && (
    <footer class="mt-12 pt-4 border-t border-border text-sm text-muted-foreground flex gap-6">
      {created && <span>创建于 {new Date(created).toLocaleDateString('zh-CN')}</span>}
      {updated && <span>更新于 {new Date(updated).toLocaleDateString('zh-CN')}</span>}
    </footer>
  )}

  <div class="mt-12">
    <Backlinks currentSlug={slug} />
  </div>
</NotesLayout>
