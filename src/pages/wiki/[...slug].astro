---
import { getCollection } from 'astro:content';
import fs from 'fs';
import path from 'path';
import WikiLayout from '../../layouts/WikiLayout.astro';
import Backlinks from '../../components/wiki/Backlinks.astro';

export async function getStaticPaths() {
  const paths = [];

  const wikiEntries = await getCollection('wiki', ({ data }) => !data.draft && !(data as any).private);
  wikiEntries.forEach((entry) => {
    const slug = entry.id.replace(/\.md$/, '');
    paths.push({
      params: { slug },
      props: { entry, slug, source: 'local' },
    });
  });

  const vaultPath = path.join(process.cwd(), 'vault', 'z');
  if (fs.existsSync(vaultPath)) {
    const walkDir = (dir: string, prefix = '') => {
      if (!fs.existsSync(dir)) return;
      
      fs.readdirSync(dir, { withFileTypes: true }).forEach((dirent) => {
        if (dirent.name.startsWith('.') || dirent.name.startsWith('_')) return;
        
        const fullPath = path.join(dir, dirent.name);
        const relativePath = prefix ? `${prefix}/${dirent.name}` : dirent.name;
        
        if (dirent.isDirectory()) {
          walkDir(fullPath, relativePath);
        } else if (dirent.name.endsWith('.md')) {
          const slug = `obsidian/${relativePath.replace(/\.md$/, '')}`;
          paths.push({
            params: { slug },
            props: { filePath: fullPath, slug, source: 'vault' },
          });
        }
      });
    };
    
    walkDir(vaultPath);
  }

  return paths;
}

interface Props {
  entry?: any;
  filePath?: string;
  slug: string;
  source: 'local' | 'vault';
}

const { entry, filePath, slug, source } = Astro.props as Props;

let title = '';
let description = '';
let headings: any[] = [];
let Content: any;
let frontmatter: any = {};

if (source === 'local' && entry) {
  title = entry.data.title;
  description = entry.data.description || '';
  const rendered = await entry.render();
  Content = rendered.Content;
  headings = rendered.headings;
  frontmatter = entry.data;
} else if (source === 'vault' && filePath) {
  const content = fs.readFileSync(filePath, 'utf-8');
  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)/);
  
  if (frontmatterMatch) {
    const [, frontmatterText, body] = frontmatterMatch;
    
    frontmatterText.split('\n').forEach((line: string) => {
      const [key, ...valueParts] = line.split(':');
      if (key && valueParts.length > 0) {
        const value = valueParts.join(':').trim();
        if (value === 'true') frontmatter[key.trim()] = true;
        else if (value === 'false') frontmatter[key.trim()] = false;
        else if (value.startsWith('[') && value.endsWith(']')) {
          try {
            frontmatter[key.trim()] = JSON.parse(value);
          } catch {
            frontmatter[key.trim()] = value;
          }
        } else frontmatter[key.trim()] = value;
      }
    });
    
    title = frontmatter.title || path.basename(filePath, '.md');
    description = frontmatter.description || '';
    Content = body;
  } else {
    title = path.basename(filePath, '.md');
    Content = content;
  }
}
---

<WikiLayout 
  title={title} 
  description={description}
  headings={headings}
  currentSlug={slug}
>
  <div class="wiki-tags">
    {frontmatter.tags?.map((tag: string) => (
      <span class="tag">#{tag}</span>
    ))}
  </div>

  {typeof Content === 'string' ? (
    <div class="prose" set:html={Content} />
  ) : (
    <Content />
  )}

  {(frontmatter.created || frontmatter.updated) && (
    <footer class="article-meta">
      {frontmatter.created && (
        <span>创建于 {new Date(frontmatter.created).toLocaleDateString('zh-CN')}</span>
      )}
      {frontmatter.updated && (
        <span>更新于 {new Date(frontmatter.updated).toLocaleDateString('zh-CN')}</span>
      )}
    </footer>
  )}

  <Backlinks currentSlug={slug} />
</WikiLayout>

<style>
  .wiki-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .tag {
    font-size: 0.8rem;
    padding: 0.2rem 0.6rem;
    background: var(--tag-bg, #e8f4fd);
    color: #0066cc;
    border-radius: 4px;
  }

  :global(html.dark) .tag {
    --tag-bg: rgba(100, 150, 255, 0.15);
    color: #6ea8fe;
  }

  .article-meta {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color, #e5e5e5);
    font-size: 0.85rem;
    color: var(--text-secondary, #888);
    display: flex;
    gap: 1.5rem;
  }

  .prose {
    line-height: 1.8;
    color: var(--text-primary, #333);
  }

  .prose :global(h2) {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color, #e5e5e5);
  }

  .prose :global(a) {
    color: #0066cc;
    text-decoration: none;
  }

  .prose :global(a:hover) {
    text-decoration: underline;
  }
</style>
