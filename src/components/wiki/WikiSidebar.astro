---
/**
 * Wiki ä¾§è¾¹æ ç»„ä»¶
 * è‡ªåŠ¨ä» wiki collection ç”Ÿæˆç›®å½•æ ‘
 * æ”¯æŒæŒ‰ tag çš„ç¬¬ä¸€ç»´åˆ†ç±»ï¼ˆObsidian å››ç»´ tag: status/tech/type/...ï¼‰
 */
import { getCollection } from 'astro:content';

interface Props {
  currentSlug?: string;
}

const { currentSlug = '' } = Astro.props;

// è·å–æ‰€æœ‰ wiki æ–‡ç« 
const allWiki = await getCollection('notes', ({ data }) => !data.draft);

// ä» tags ä¸­æå–åˆ†ç±»
// ä½ çš„ tag æ ¼å¼ï¼šstatus/growing, tech/dev/frontend/eng, type/debug
// æˆ‘ä»¬å–ç¬¬ä¸€ä¸ª "/" å‰é¢çš„éƒ¨åˆ†ä½œä¸º category
interface WikiEntry {
  slug: string;
  title: string;
  order?: number;
}

const categories = new Map<string, WikiEntry[]>();

allWiki.forEach((entry) => {
  // ä¼˜å…ˆä½¿ç”¨ category å­—æ®µï¼Œå…¶æ¬¡ä» tags ç¬¬ä¸€ä¸ªæ ‡ç­¾æ¨æ–­
  let category = entry.data.category;
  
  if (!category && entry.data.tags && entry.data.tags.length > 0) {
    // ä» tags[0] ä¸­æå–ç¬¬ä¸€ç»´
    const firstTag = entry.data.tags[0];
    category = firstTag.split('/')[0];
  }
  
  category = category || 'æœªåˆ†ç±»';

  if (!categories.has(category)) {
    categories.set(category, []);
  }
  
  // glob loader çš„ id å·²ä¸å« .md åç¼€
  const slug = entry.id;
  categories.get(category)!.push({
    slug,
    title: entry.data.title,
    order: (entry.data as any).order || 999,
  });
});

// æŒ‰ order æ’åºæ¯ä¸ªåˆ†ç±»å†…çš„æ¡ç›®
categories.forEach((entries) => {
  entries.sort((a, b) => (a.order || 999) - (b.order || 999));
});

// æŒ‰åˆ†ç±»åæ’åº
const sortedCategories = Array.from(categories.entries()).sort((a, b) => 
  a[0].localeCompare(b[0], 'zh-CN')
);
---

<nav class="wiki-nav">
  {sortedCategories.length === 0 ? (
    <div class="empty-nav">
      <p>ğŸ“‚ æš‚æ— æ–‡æ¡£</p>
      <p class="hint">åœ¨ <code>src/content/wiki/</code> æ·»åŠ  Markdown æ–‡ä»¶</p>
    </div>
  ) : (
    sortedCategories.map(([category, entries]) => (
      <div class="nav-group">
        <h4 class="nav-category">{category}</h4>
        <ul class="nav-list">
          {entries.map((entry) => (
            <li>
                <a 
                href={`/notes/${entry.slug}`} 
                class:list={['nav-item', { active: currentSlug === entry.slug }]}
              >
                {entry.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    ))
  )}
</nav>

<style>
  .wiki-nav {
    font-size: 0.9rem;
  }

  .empty-nav {
    color: var(--text-secondary, #888);
    font-size: 0.85rem;
    text-align: center;
    padding: 1rem;
  }

  .empty-nav code {
    background: var(--code-bg, #f0f0f0);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  .hint {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .nav-group {
    margin-bottom: 1.5rem;
  }

  .nav-category {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary, #888);
    margin: 0 0 0.5rem 0;
    padding-left: 0.5rem;
  }

  .nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-item {
    display: block;
    padding: 0.5rem 0.75rem;
    color: var(--text-primary, #333);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.15s ease;
  }

  .nav-item:hover {
    background: var(--hover-bg, rgba(0, 102, 204, 0.08));
    color: #0066cc;
  }

  .nav-item.active {
    background: var(--active-bg, rgba(0, 102, 204, 0.12));
    color: #0066cc;
    font-weight: 500;
  }

  :global(html.dark) .nav-item {
    color: #ccc;
  }

  :global(html.dark) .nav-item:hover,
  :global(html.dark) .nav-item.active {
    background: rgba(100, 150, 255, 0.15);
    color: #6ea8fe;
  }
</style>
