---
/**
 * Wiki ä¾§è¾¹æ ç»„ä»¶
 * è‡ªåŠ¨ä» wiki collection ç”Ÿæˆç›®å½•æ ‘
 * æ”¯æŒæŒ‰ tag çš„ç¬¬ä¸€ç»´åˆ†ç±»ï¼ˆObsidian å››ç»´ tag: status/tech/type/...ï¼‰
 */
import { getCollection } from 'astro:content';

interface Props {
  currentSlug?: string;
}

const { currentSlug = '' } = Astro.props;

// è·å–æ‰€æœ‰ wiki æ–‡ç« 
const allWiki = await getCollection('notes', ({ data }) => !data.draft && !(data as any).private);

// ä» tags ä¸­æå–åˆ†ç±»
// ä½ çš„ tag æ ¼å¼ï¼šstatus/growing, tech/dev/frontend/eng, type/debug
// æˆ‘ä»¬å–ç¬¬ä¸€ä¸ª "/" å‰é¢çš„éƒ¨åˆ†ä½œä¸º category
interface WikiEntry {
  slug: string;
  title: string;
  order?: number;
}

const categories = new Map<string, WikiEntry[]>();

allWiki.forEach((entry) => {
  // ä¼˜å…ˆä½¿ç”¨ category å­—æ®µï¼Œå…¶æ¬¡ä» tags ç¬¬ä¸€ä¸ªæ ‡ç­¾æ¨æ–­
  let category = entry.data.category;
  
  if (!category && entry.data.tags && entry.data.tags.length > 0) {
    // ä» tags[0] ä¸­æå–ç¬¬ä¸€ç»´
    const firstTag = entry.data.tags[0];
    category = firstTag.split('/')[0];
  }
  
  category = category || 'æœªåˆ†ç±»';

  if (!categories.has(category)) {
    categories.set(category, []);
  }
  
  // glob loader çš„ id å·²ä¸å« .md åç¼€
  const slug = entry.id;
  categories.get(category)!.push({
    slug,
    title: entry.data.title,
    order: (entry.data as any).order || 999,
  });
});

// æŒ‰ order æ’åºæ¯ä¸ªåˆ†ç±»å†…çš„æ¡ç›®
categories.forEach((entries) => {
  entries.sort((a, b) => (a.order || 999) - (b.order || 999));
});

// æŒ‰åˆ†ç±»åæ’åº
const sortedCategories = Array.from(categories.entries()).sort((a, b) => 
  a[0].localeCompare(b[0], 'zh-CN')
);
---

<nav class="text-sm">
  {sortedCategories.length === 0 ? (
    <div class="text-center p-4 text-muted-foreground text-sm">
      <p>ğŸ“‚ æš‚æ— æ–‡æ¡£</p>
      <p class="mt-2 text-xs">åœ¨ <code class="bg-card px-1.5 py-0.5 rounded text-xs">src/content/wiki/</code> æ·»åŠ  Markdown æ–‡ä»¶</p>
    </div>
  ) : (
    sortedCategories.map(([category, entries]) => (
      <div class="mb-6">
        <h4 class="text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-2 pl-2">{category}</h4>
        <ul class="m-0 p-0 list-none space-y-0.5">
          {entries.map((entry) => (
            <li>
                <a 
                href={`/notes/${entry.slug}`} 
                class:list={[
                  'block px-3 py-1.5 rounded-md transition-colors duration-150',
                  currentSlug === entry.slug
                    ? 'bg-primary/10 text-primary font-medium'
                    : 'text-foreground/80 hover:bg-primary/5 hover:text-primary'
                ]}
              >
                {entry.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    ))
  )}
</nav>
