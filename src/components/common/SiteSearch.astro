---
// SiteSearch.astro
// This component contains the search modal and initializing scripts.
// Include this ONCE in your layout or header.
// To trigger the search modal, use a button with class="search-trigger"
---

<div id="search-modal" class="fixed inset-0 z-[100] hidden bg-background/80 backdrop-blur-sm transition-opacity" aria-hidden="true">
  <div class="fixed inset-0 z-[101] flex items-start justify-center pt-20 sm:pt-24">
    <div 
      id="search-container"
      class="w-full max-w-2xl overflow-hidden rounded-xl border border-border bg-card shadow-2xl transition-all sm:mx-6"
      role="dialog"
      aria-modal="true"
      aria-label="Site Search"
    >
      <div id="pagefind-search" class="w-full px-4 py-4"></div>
      
      <div class="border-t border-border px-4 py-3 bg-muted/30 text-xs text-muted-foreground flex justify-between">
        <span class="flex gap-4">
          <span><kbd class="font-mono bg-background border border-border rounded px-1.5 py-0.5">esc</kbd> close</span>
          <span><kbd class="font-mono bg-background border border-border rounded px-1.5 py-0.5">↑↓</kbd> navigate</span>
          <span><kbd class="font-mono bg-background border border-border rounded px-1.5 py-0.5">↵</kbd> select</span>
        </span>
        <span class="hidden sm:inline-block">Powered by Pagefind</span>
      </div>
    </div>
  </div>
</div>

<!-- Pagefind styles are in global.css to override variables -->
<style is:global>
  @reference "../../styles/global.css";

  /* Customizing Pagefind UI to match our theme */
  .pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-font: inherit;
  }
  
  .pagefind-ui__search-input {
    @apply bg-background border border-border rounded-lg text-foreground focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all;
    font-weight: 400 !important;
  }
  
  .pagefind-ui__search-clear {
    @apply bg-card-hover text-foreground hover:bg-primary/10 rounded-md;
  }
  
  .pagefind-ui__result {
    @apply border-border py-4 transition-colors hover:bg-card-hover/50 rounded-lg px-2 -mx-2;
  }
  
  .pagefind-ui__result-title {
    @apply text-foreground font-medium mb-1;
  }
  
  .pagefind-ui__result-excerpt {
    @apply text-muted-foreground text-sm;
  }
  
  .pagefind-ui__message {
    @apply text-muted-foreground text-sm py-4;
  }

  .pagefind-ui__button {
    @apply bg-card-hover border border-border text-foreground hover:bg-primary hover:text-white transition-colors rounded-md;
  }
  
  .pagefind-ui__drawer {
    /* Hide scrollbar but keep functionality */
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .pagefind-ui__drawer::-webkit-scrollbar {
    display: none;
  }
  
  mark {
    @apply bg-primary/20 text-primary font-medium rounded-sm px-0.5;
  }
</style>

<script>
  let pagefindInstance: any = null;
  const searchModal = document.getElementById('search-modal');
  const searchTriggers = document.querySelectorAll('.search-trigger');
  const searchContainer = document.getElementById('search-container');
  
  // Dynamic import of Pagefind UI
  async function initPagefind() {
    if (pagefindInstance) return;
    
    try {
      // @ts-ignore
      const { PagefindUI } = await import('@pagefind/default-ui');
      // @ts-ignore
      await import('@pagefind/default-ui/css/ui.css');
      
      pagefindInstance = new PagefindUI({
        element: "#pagefind-search",
        showSubResults: true,
        showImages: false,
        resetStyles: false, // We're using our own styles
        bundlePath: "/pagefind/", // This tells it where to look for the search index
      });
      
      // Focus input after initializing
      setTimeout(() => {
        const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        if (input) input.focus();
      }, 100);
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
      document.getElementById('pagefind-search')!.innerHTML = 
        '<div class="p-4 text-center text-red-500">Failed to load search. Please build the site first using `pnpm build`.</div>';
    }
  }

  function openSearch() {
    if (!searchModal) return;
    searchModal.classList.remove('hidden');
    searchModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
    
    initPagefind().then(() => {
      const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
      if (input) input.focus();
    });
  }

  function closeSearch() {
    if (!searchModal) return;
    searchModal.classList.add('hidden');
    searchModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  // Event Listeners
  searchTriggers.forEach(trigger => {
    trigger.addEventListener('click', openSearch);
  });
  
  searchModal?.addEventListener('click', (e) => {
    if (e.target === searchModal) {
      closeSearch();
    }
  });

  document.addEventListener('keydown', (e) => {
    // CMD/CTRL + K to open
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (searchModal?.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }
    
    // ESC to close
    if (e.key === 'Escape' && !searchModal?.classList.contains('hidden')) {
      e.preventDefault();
      closeSearch();
    }
  });
</script>