---
/**
 * 文章目录组件 (Table of Contents)
 * 显示当前文章的标题大纲
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// 只显示 h2 和 h3
const filteredHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="text-sm">
    <h4 class="text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-3">目录</h4>
    <ul class="m-0 p-0 list-none space-y-1">
      {filteredHeadings.map((heading) => (
        <li class="my-1">
          <a 
            href={`#${heading.slug}`} 
            class:list={[
              'block py-1 px-2 border-l-2 border-transparent text-muted-foreground no-underline hover:text-primary hover:border-primary transition-all duration-150 leading-snug',
              heading.depth === 3 && 'pl-4'
            ]}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  // 滚动高亮当前标题
  const tocLinks = document.querySelectorAll('nav.text-sm a[href^="#"]');
  const headings = document.querySelectorAll('.prose h2[id], .prose h3[id]');

  if (tocLinks.length && headings.length) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            tocLinks.forEach((link) => {
              const isActive = link.getAttribute('href') === `#${id}`;
              
              if (isActive) {
                link.classList.add('text-primary', 'border-primary', 'font-medium');
                link.classList.remove('text-muted-foreground', 'border-transparent');
              } else {
                link.classList.remove('text-primary', 'border-primary', 'font-medium');
                link.classList.add('text-muted-foreground', 'border-transparent');
              }
            });
          }
        });
      },
      { rootMargin: '-80px 0px -80% 0px' }
    );

    headings.forEach((h) => observer.observe(h));
  }
</script>
