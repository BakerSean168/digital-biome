---
/**
 * 智能搜索框组件
 * 支持快捷命令：
 *   tr <text>  → Google 翻译
 *   g <query>  → Google 搜索
 *   gh <query> → GitHub 搜索
 *   b <query>  → Bing 搜索
 *   w <query>  → Wikipedia
 *   直接输入   → 默认搜索引擎
 */
import { Search } from '@lucide/astro';

interface Props {
  placeholder?: string;
  defaultEngine?: 'google' | 'bing' | 'duckduckgo';
}

const { 
  placeholder = 'Search...', 
  defaultEngine = 'google' 
} = Astro.props;
---

<div class="w-full max-w-3xl mx-auto my-12 relative z-10">
  <div class="relative group">
    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
      <Search class="text-muted-foreground group-focus-within:text-primary transition-colors" size={20} />
    </div>
    <input 
      type="text" 
      id="smart-search" 
      placeholder={placeholder}
      autocomplete="off"
      data-engine={defaultEngine}
      class="w-full pl-12 pr-4 py-3 bg-card/10 backdrop-blur-md border border-primary/50 rounded-full text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all duration-300 shadow-sm"
    />
    <div class="absolute left-0 right-0 top-full mt-3 flex justify-center gap-4 opacity-0 -translate-y-2 pointer-events-none transition-all duration-200" id="search-hints">
      <span class="text-xs text-muted-foreground"><kbd class="bg-card-hover px-1.5 py-0.5 rounded border border-border mr-1 font-mono">tr</kbd>翻译</span>
      <span class="text-xs text-muted-foreground"><kbd class="bg-card-hover px-1.5 py-0.5 rounded border border-border mr-1 font-mono">g</kbd>Google</span>
      <span class="text-xs text-muted-foreground"><kbd class="bg-card-hover px-1.5 py-0.5 rounded border border-border mr-1 font-mono">gh</kbd>GitHub</span>
      <span class="text-xs text-muted-foreground"><kbd class="bg-card-hover px-1.5 py-0.5 rounded border border-border mr-1 font-mono">w</kbd>Wiki</span>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById('smart-search') as HTMLInputElement;
  const hints = document.getElementById('search-hints');
  
  const COMMANDS: Record<string, (query: string) => string> = {
    'tr': (q) => `https://translate.google.com/?sl=auto&tl=zh-CN&text=${encodeURIComponent(q)}`,
    'g': (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
    'gh': (q) => `https://github.com/search?q=${encodeURIComponent(q)}`,
    'b': (q) => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
    'w': (q) => `https://zh.wikipedia.org/wiki/${encodeURIComponent(q)}`,
    'yt': (q) => `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`,
  };

  const DEFAULT_ENGINES: Record<string, (q: string) => string> = {
    'google': (q) => `https://www.google.com/search?q=${encodeURIComponent(q)}`,
    'bing': (q) => `https://www.bing.com/search?q=${encodeURIComponent(q)}`,
    'duckduckgo': (q) => `https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
  };

  searchInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const value = searchInput.value.trim();
      if (!value) return;

      const parts = value.split(' ');
      const cmd = parts[0].toLowerCase();
      const query = parts.slice(1).join(' ');

      let url: string;
      if (COMMANDS[cmd] && query) {
        url = COMMANDS[cmd](query);
      } else {
        const engine = searchInput.dataset.engine || 'google';
        url = DEFAULT_ENGINES[engine](value);
      }

      window.open(url, '_blank');
      searchInput.value = '';
    }
  });

  searchInput?.addEventListener('focus', () => {
    hints?.classList.remove('opacity-0', '-translate-y-2');
    hints?.classList.add('opacity-100', 'translate-y-0');
  });

  searchInput?.addEventListener('blur', () => {
    setTimeout(() => {
      hints?.classList.add('opacity-0', '-translate-y-2');
      hints?.classList.remove('opacity-100', 'translate-y-0');
    }, 200);
  });

  // 自动聚焦
  if (window.innerWidth > 768) {
    searchInput?.focus();
  }
</script>
